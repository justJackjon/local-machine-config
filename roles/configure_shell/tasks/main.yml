- name: Configure Shell
  block:
    - name: Change default MacOS shell from zsh to bash
      when: is_mac
      become: true
      block:
        - name: Add Homebrew's Bash to the list of allowed shells
          lineinfile:
            path: /etc/shells
            line: /opt/homebrew/bin/bash
            state: present
        - name: Change default shell to Homebrew's Bash
          command: chsh -s /opt/homebrew/bin/bash {{ ansible_user_id }}

- name: Enable tab completion for Ansible CLI commands
  block:
    - name: Install argcomplete for Ansible tab completion
      block:
        - name: Install argcomplete on non-Windows systems using Pip
          when: not is_windows
          pip:
            name:
              - argcomplete
            state: present
            extra_args: "{{ '--user --break-system-packages' if is_mac else '--user' }}"
        - name: Install argcomplete on Windows MSYS2 systems using Pacman
          when: is_windows
          pacman:
            name: mingw-w64-x86_64-python-argcomplete
            state: present
            update_cache: true

    - name: Find Python user base 
      when: is_mac
      command: "{{ ansible_python_interpreter }} -m site --user-base"
      register: python_user_base
      changed_when: false

    - name: Activate global argcomplete for macOS
      when: is_mac
      shell: yes | {{ python_user_base.stdout }}/bin/activate-global-python-argcomplete --user
      args:
        executable: /bin/bash

    - name: Source argcomplete completion script for Debian-based systems
      when: is_debian_family
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        line: "source /usr/lib/python3/dist-packages/argcomplete/bash_completion.d/python-argcomplete.sh"
        create: true
        mode: '0644'

    - name: Activate global argcomplete for Windows (MSYS2)
      when: is_windows
      shell: yes | /mingw64/bin/activate-global-python-argcomplete --user
      args:
        executable: /bin/bash

- name: Source .dotfilesrc in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: "source {{ ansible_env.HOME }}/.dotfilesrc"
    create: true
    mode: '0644'
