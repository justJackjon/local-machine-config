- name: Install debian packages
  when: is_debian_family
  block:
    # NOTE: The following packages are required for lazyvim and its plugins.
    #       - fd-find: Required by lazyvim and snacks for file searching (fd)
    #       - lazygit: Required by lazyvim and snacks for git integration
    #       - luarocks: Required by lazy and mason for Lua plugin management
    #       - imagemagick: Required by snacks for image previews
    #       - sqlite3: Required by snacks for history and frecency
    #       - libsqlite3-dev: Required by snacks for history and frecency (dev headers)
    - name: Install required packages for Debian based systems
      become: true
      ansible.builtin.apt:
        name:
          - python3-pip
          - pipx
          - bash-completion
          - stow
          - gnupg
          - xclip
          - tldr
          - tree
          - jq
          - ssh-askpass
          - fonts-noto-color-emoji
          - ripgrep
          - fd-find
          - luarocks
          - imagemagick
          - sqlite3
          - libsqlite3-dev
          - libfontconfig1-dev
          - pkg-config
        state: latest
        update_cache: true

    - name: Install Rust via rustup
      become: true
      block:
        - name: Check if rustup is installed
          ansible.builtin.stat:
            path: "/root/.cargo/bin/rustup"
          register: rustup_stat_root

        - name: Download rustup installer
          when: not rustup_stat_root.stat.exists
          ansible.builtin.get_url:
            url: https://sh.rustup.rs
            dest: /tmp/rustup-init.sh
            mode: "0755"

        - name: Run rustup installer for root user
          when: not rustup_stat_root.stat.exists
          ansible.builtin.command: /tmp/rustup-init.sh -y
          changed_when: true

    - name: Install Alacritty via cargo for Debian based systems
      become: true
      community.general.cargo:
        name: alacritty
        state: present
      environment:
        PATH: "/root/.cargo/bin:{{ ansible_env.PATH }}"
        CARGO_INSTALL_ROOT: "/usr/local"

    - name: Install gh for Debian based systems
      become: true
      block:
        - name: Create apt keyrings directory
          ansible.builtin.file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"

        - name: Download GitHub CLI GPG keyring
          ansible.builtin.get_url:
            url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
            dest: /etc/apt/keyrings/githubcli-archive-keyring.gpg
            mode: '0644'
            force: true

        - name: Add GitHub CLI apt repository
          ansible.builtin.apt_repository:
            repo: "deb [arch={{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else 'i386' }} signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
            state: present
            filename: github-cli

        - name: Install latest gh CLI
          ansible.builtin.apt:
            name: gh
            state: latest
            update_cache: true

    - name: Install lazygit
      become: true
      block:
        - name: Install lazygit from apt on Debian >= 13 or Ubuntu >= 25.10
          when: >
            (ansible_distribution == 'Debian' and ansible_distribution_version | float >= 13) or
            (ansible_distribution == 'Ubuntu' and ansible_distribution_version | float >= 25.10)
          ansible.builtin.apt:
            name: lazygit
            state: present
            update_cache: true

        - name: Install lazygit from source on older Debian/Ubuntu
          when: >
            (ansible_distribution == 'Debian' and ansible_distribution_version | float < 13) or
            (ansible_distribution == 'Ubuntu' and ansible_distribution_version | float < 25.10)
          block:
            - name: Get latest lazygit version
              ansible.builtin.uri:
                url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
                return_content: true
              register: install_base_packages_lazygit_release

            - name: Set lazygit version fact
              ansible.builtin.set_fact:
                install_base_packages_lazygit_version: "{{ install_base_packages_lazygit_release.json.tag_name | regex_replace('^v', '') }}"

            - name: Download and unarchive lazygit
              ansible.builtin.unarchive:
                src: "https://github.com/jesseduffield/lazygit/releases/download/v{{ install_base_packages_lazygit_version }}/lazygit_{{ install_base_packages_lazygit_version }}_Linux_x86_64.tar.gz" # noqa: line-length
                dest: /tmp
                remote_src: true

            - name: Install lazygit
              ansible.builtin.copy:
                src: /tmp/lazygit
                dest: /usr/local/bin/lazygit
                mode: "0755"
                remote_src: true

    - name: Uninstall apt-managed fzf for Debian based systems
      become: true
      ansible.builtin.apt:
        name: fzf
        state: absent
        autoremove: true
      # NOTE: We are uninstalling the apt-managed version of fzf because it is often outdated
      #       and causes compatibility issues with fzf-lua. We will install fzf from source instead.

    - name: Install fzf from source for Debian based systems
      block:
        # NOTE: The apt package for fzf is often outdated, leading to compatibility issues with fzf-lua.
        #       Installing directly from source ensures the latest version with all features.
        - name: Get latest fzf release tag
          ansible.builtin.uri:
            url: https://api.github.com/repos/junegunn/fzf/releases/latest
            method: GET
            return_content: true
          register: install_base_packages_fzf_release_info

        - name: Set fzf_version fact
          ansible.builtin.set_fact:
            install_base_packages_fzf_version: "{{ install_base_packages_fzf_release_info.json.tag_name }}"

        - name: Clone fzf repository
          ansible.builtin.git:
            repo: "https://github.com/junegunn/fzf.git"
            dest: "{{ ansible_env.HOME }}/.fzf"
            version: "{{ install_base_packages_fzf_version }}"
            depth: 1
            force: true
          changed_when: false # noqa: latest[git]

        - name: Run fzf install script
          ansible.builtin.command: "{{ ansible_env.HOME }}/.fzf/install --all"
          args:
            creates: "{{ ansible_env.HOME }}/.fzf/bin/fzf"
          changed_when: false

    - name: Install nvm, node and pnpm
      block:
        - name: Download nvm install script
          ansible.builtin.get_url:
            url: |
              https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh
            dest: /tmp/install_nvm.sh
            mode: "0755"

        - name: Run nvm install script
          ansible.builtin.command: /tmp/install_nvm.sh
          args:
            creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

        - name: Install Node.js LTS
          ansible.builtin.shell: >
            set -o pipefail && source {{ ansible_env.HOME }}/.nvm/nvm.sh && nvm install --lts
          args:
            executable: /bin/bash
            creates: "{{ ansible_env.HOME }}/.nvm/versions/node"

        - name: Check if pnpm is installed
          ansible.builtin.stat:
            path: "{{ ansible_env.HOME }}/.local/share/pnpm/pnpm"
          register: install_base_packages_pnpm_stat_debian

        - name: Download pnpm install script
          when: not install_base_packages_pnpm_stat_debian.stat.exists
          ansible.builtin.get_url:
            url: https://get.pnpm.io/install.sh
            dest: /tmp/install_pnpm.sh
            mode: "0755"

        - name: Run pnpm install script
          when: not install_base_packages_pnpm_stat_debian.stat.exists
          ansible.builtin.command: sh /tmp/install_pnpm.sh
          changed_when: false

        - name: Update pnpm
          when: install_base_packages_pnpm_stat_debian.stat.exists
          ansible.builtin.shell:
            cmd: "{{ ansible_env.HOME }}/.local/share/pnpm/pnpm self-update"
          args:
            executable: /bin/bash
            chdir: "{{ ansible_env.HOME }}"
          changed_when: false

    - name: Install pnpm packages
      community.general.pnpm:
        global: true
        state: latest
      with_items:
        - tree-sitter-cli
        - neovim

    - name: Install pipx packages
      ansible.builtin.command:
        cmd: pipx install {{ item }}
      with_items:
        - ansible-lint
        - pynvim
      changed_when: false
