- name: Ensure .dotfiles directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.dotfiles"
    state: directory
    mode: "0755"

- name: Check for local changes in .dotfiles repository
  ansible.builtin.command: git status --porcelain
  args:
    chdir: "{{ ansible_env.HOME }}/.dotfiles"
  register: git_status
  changed_when: false
  ignore_errors: true

- name: Stash local changes if any
  ansible.builtin.command: git stash
  args:
    chdir: "{{ ansible_env.HOME }}/.dotfiles"
  when: git_status.stdout is defined and git_status.stdout != ""
  register: git_stash

- name: Clone or update .dotfiles repository
  ansible.builtin.git:
    repo: "https://github.com/justJackjon/.dotfiles.git"
    dest: "{{ ansible_env.HOME }}/.dotfiles"
    version: main
    update: yes
    accept_hostkey: yes

- name: Stow dotfiles with --adopt and restore git changes
  ansible.builtin.shell:
    cmd: |
      cd "{{ ansible_env.HOME }}/.dotfiles"
      # NOTE: The --adopt flag is used to take ownership of existing files in the home directory
      #       that would otherwise conflict with stow's symlinking process. This allows stow
      #       to create symlinks for these files and move the original files into the .dotfiles
      #       repository. Immediately after, 'git restore .' is used to revert these changes
      #       in the .dotfiles repository, ensuring that the repository remains clean and
      #       reflects only the intended dotfiles from the origin.
      stow */ --adopt
      git restore .
  args:
    chdir: "{{ ansible_env.HOME }}/.dotfiles"
  changed_when: true

- name: Unstash local changes
  ansible.builtin.command: git stash pop
  args:
    chdir: "{{ ansible_env.HOME }}/.dotfiles"
  when: git_stash.stdout is defined and "Saved working directory and index state" in git_stash.stdout
