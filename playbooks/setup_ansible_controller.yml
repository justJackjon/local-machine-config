- name: Setup Ansible Controller
  hosts: localhost
  connection: local
  gather_facts: false
  pre_tasks:
    - include_tasks: ../common/tasks/set_python_interpreter.yml
    - name: Manually gather facts once python interpreter is set
      setup:
    - name: Ensure 'packaging' library is installed for Ansible's Python environment (macOS)
      when: ansible_facts.os_family == 'Darwin'
      ansible.builtin.command: /opt/homebrew/opt/python@3.12/bin/pip3 install packaging --break-system-packages --user
      changed_when: false
      failed_when: false # Allow this to fail if packaging is already installed or if pip is not found

    - include_tasks: ../common/tasks/set_os_facts.yml
    - include_tasks: ../common/tasks/set_sys_architecture_facts.yml
  roles:
    - install_base_packages
    - role: install_wsl_gui
      when: is_wsl | default(false)
    - configure_shell
    - configure_keyboard
    - install_browser
    - install_lazyvim
    - stow_dotfiles

  post_tasks:
    - name: Display final instructions
      ansible.builtin.debug:
        msg:
          - "Playbook execution finished."
          - "If you are having issues with commands not being found (e.g. 'nvim'), please run 'hash -r' or open a new terminal session to refresh your shell's command cache."
