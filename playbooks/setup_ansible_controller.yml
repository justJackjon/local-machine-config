- name: Setup Ansible Controller
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    - name: Set python interpreter
      ansible.builtin.include_tasks: ../common/tasks/set_python_interpreter.yml
      tags: always

      # NOTE: Manually father facts once python interpreter is set...
    - name: Manually gather facts
      ansible.builtin.setup:
      tags: always

    - name: Set OS facts
      ansible.builtin.include_tasks: ../common/tasks/set_os_facts.yml
      tags: always

    - name: Set system architecture facts
      ansible.builtin.include_tasks: ../common/tasks/set_sys_architecture_facts.yml
      tags: always

    - name: Set is_inside_xfce fact
      ansible.builtin.set_fact:
        is_inside_xfce: "{{ ansible_facts.env.XDG_CURRENT_DESKTOP is defined and ansible_facts.env.XDG_CURRENT_DESKTOP == 'XFCE' }}"
      tags: always

    - name: Execute pre-flight checks
      ansible.builtin.include_tasks: ../roles/pre_flight_checks/tasks/main.yml
      tags: configure_git

  roles:
    - role: configure_msys2
      when: is_windows

    - role: install_base_packages
      tags: [install_base_packages, configure_git]

    - role: configure_system
      when: ansible_facts.os_family == 'Debian'

    - role: install_wsl_gui
      when: is_wsl | default(false)

    - configure_shell
    - role: configure_keyboard
      tags: configure_keyboard
    - install_browser
    - install_lazyvim
    - stow_dotfiles

    - role: configure_git
      tags: configure_git

  post_tasks:
    - name: Display final instructions
      ansible.builtin.debug:
        msg:
          - "Playbook execution finished."
          - >-
            If you are having issues with commands not being found (e.g. 'nvim'),
            please run 'hash -r' or open a new terminal session to refresh your shell's command cache.

    - name: Add final instructions for GitHub
      ansible.builtin.debug:
        msg:
          - "GitHub Configuration Instructions:"
          - "1. Your SSH and GPG keys have been automatically added to your GitHub account."
          - "   If you have issues, ensure you are authenticated with the GitHub CLI by running 'gh auth login'."
          - ""
          - "2. IMPORTANT: You may need to start a new shell session (or run 'source ~/.bashrc') for the SSH agent to be available."
          - "   Until you do, operations like 'git clone' that require SSH may fail."
          - ""
          - "3. For work repositories, you can use a different git configuration by running the following commands inside the repository:"
          - '   git config --local user.name "Your Work Name"'
          - '   git config --local user.email "your-work@example.com"'
          - ""
          - "4. For manual key management:"
          - "   - Your public SSH key is at: {{ ansible_env.HOME }}/.ssh/ansible-managed/github/id_rsa.pub"
          - "   - To get your public GPG key, run:"
          - "     gpg --armor --export --homedir {{ ansible_env.HOME }}/.gnupg/ansible-managed/github {{ configure_git_user_email }}"
      tags: configure_git
